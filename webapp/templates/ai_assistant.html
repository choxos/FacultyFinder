{% extends "base.html" %}

{% block title %}AI Assistant - FacultyFinder{% endblock %}

{% block extra_css %}
<style>
.upload-area {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.upload-area:hover {
    border-color: #0056b3;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.upload-area.dragover {
    border-color: #28a745;
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.file-icon {
    font-size: 3rem;
    color: #007bff;
    margin-bottom: 1rem;
}

.pricing-card {
    transition: transform 0.2s;
    border: 2px solid transparent;
}

.pricing-card:hover {
    transform: translateY(-5px);
    border-color: #007bff;
}

.pricing-card.recommended {
    border-color: #28a745;
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.ai-service-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
}

.ai-service-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.ai-service-card.selected {
    border-color: #007bff;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.profile-info {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 4px solid #ffc107;
}

.field-selection {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
}

.category-badge {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
}

.analysis-result {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-left: 4px solid #17a2b8;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.payment-method-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.payment-method-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.payment-method-card.selected {
    border-color: var(--ff-primary-color) !important;
    background-color: rgba(var(--ff-primary-rgb), 0.05);
}

.crypto-currency-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.crypto-currency-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.crypto-currency-card.selected {
    border-color: var(--ff-primary-color) !important;
    background-color: rgba(var(--ff-primary-rgb), 0.05);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-robot me-3"></i>AI Faculty Matching Assistant
            </h1>
            <p class="lead text-muted">
                Upload your CV and get personalized faculty recommendations powered by advanced AI
            </p>
        </div>
    </div>

    <!-- AI Usage Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">
                        <i class="fas fa-chart-line me-2 text-primary"></i>AI Assistant Usage Statistics
                    </h5>
                    <div class="row text-center">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="p-3">
                                <div class="display-6 fw-bold text-primary">{{ ai_stats.total_sessions }}</div>
                                <small class="text-muted">Total Sessions</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="p-3">
                                <div class="display-6 fw-bold text-success">{{ ai_stats.successful_sessions }}</div>
                                <small class="text-muted">Successful Analyses</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="p-3">
                                <div class="display-6 fw-bold text-info">{{ ai_stats.sessions_last_7_days }}</div>
                                <small class="text-muted">Last 7 Days</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="p-3">
                                <div class="display-6 fw-bold text-warning">{{ ai_stats.sessions_last_30_days }}</div>
                                <small class="text-muted">Last 30 Days</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>Join thousands of students who have found their ideal faculty match!
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Information -->
    {% if current_user.is_authenticated %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card profile-info">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-user-circle me-2"></i>Your Profile Information
                        </h5>
                        <p class="text-muted small mb-3">
                            We'll use this information to provide better recommendations. You can update it below if needed.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="userName" 
                                           value="{{ current_user.get_full_name() }}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="userInstitution" class="form-label">Current Institution</label>
                                    <input type="text" class="form-control" id="userInstitution" 
                                           value="{{ current_user.institution }}" 
                                           placeholder="Enter your current institution">
                                </div>
                                <div class="mb-3">
                                    <label for="userLevel" class="form-label">Academic Level</label>
                                    <select class="form-select" id="userLevel">
                                        <option value="">Select your academic level</option>
                                        <option value="undergraduate" {{ 'selected' if current_user.academic_level == 'undergraduate' else '' }}>Undergraduate Student</option>
                                        <option value="graduate_masters" {{ 'selected' if current_user.academic_level == 'graduate' else '' }}>Graduate Student (Masters)</option>
                                        <option value="graduate_phd" {{ 'selected' if current_user.academic_level == 'graduate' else '' }}>Graduate Student (PhD)</option>
                                        <option value="postdoc" {{ 'selected' if current_user.academic_level == 'postdoc' else '' }}>Postdoctoral Researcher</option>
                                        <option value="faculty" {{ 'selected' if current_user.academic_level == 'faculty' else '' }}>Faculty Member</option>
                                        <option value="industry" {{ 'selected' if current_user.academic_level == 'other' else '' }}>Industry Professional</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="userEmail" 
                                           value="{{ current_user.email }}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="userWebsite" class="form-label">Website/Portfolio</label>
                                    <input type="url" class="form-control" id="userWebsite" 
                                           value="{{ current_user.website }}" 
                                           placeholder="https://your-website.com">
                                </div>
                                <div class="mb-3">
                                    <label for="userOrcid" class="form-label">ORCID ID</label>
                                    <input type="text" class="form-control" id="userOrcid" 
                                           value="{{ current_user.orcid }}" 
                                           placeholder="0000-0000-0000-0000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userBio" class="form-label">Research Interests & Background</label>
                            <textarea class="form-control" id="userBio" rows="3" 
                                      placeholder="Describe your research interests, academic background, and career goals...">{{ current_user.bio }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Guest User Information Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="fas fa-user-plus me-2"></i>Your Contact Information
                        </h5>
                        <p class="text-muted small mb-3">
                            Please provide your contact information so we can send you the AI analysis results and recommendations.
                        </p>
                        
                        <div class="alert alert-info d-flex align-items-center mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <strong>Want to save your information?</strong> 
                                <a href="/auth/register" class="alert-link">Create a free account</a> 
                                to save your preferences and access your analysis history.
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="guestName" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="guestName" 
                                           placeholder="Enter your full name" required>
                                    <div class="form-text">This will be used for personalized recommendations</div>
                                </div>
                                <div class="mb-3">
                                    <label for="guestEmail" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="guestEmail" 
                                           placeholder="your.email@example.com" required>
                                    <div class="form-text">We'll send your analysis results to this email</div>
                                </div>
                                <div class="mb-3">
                                    <label for="guestPhone" class="form-label">Phone Number (Optional)</label>
                                    <input type="tel" class="form-control" id="guestPhone" 
                                           placeholder="+1 (555) 123-4567">
                                    <div class="form-text">For follow-up consultation if needed</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="guestInstitution" class="form-label">Current Institution</label>
                                    <input type="text" class="form-control" id="guestInstitution" 
                                           placeholder="University or Organization">
                                </div>
                                <div class="mb-3">
                                    <label for="guestLevel" class="form-label">Academic Level *</label>
                                    <select class="form-select" id="guestLevel" required>
                                        <option value="">Select your academic level</option>
                                        <option value="high_school">High School Student</option>
                                        <option value="undergraduate">Undergraduate Student</option>
                                        <option value="graduate_masters">Graduate Student (Masters)</option>
                                        <option value="graduate_phd">Graduate Student (PhD)</option>
                                        <option value="postdoc">Postdoctoral Researcher</option>
                                        <option value="early_career">Early Career Researcher</option>
                                        <option value="faculty">Faculty Member</option>
                                        <option value="industry">Industry Professional</option>
                                        <option value="career_change">Career Changer</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="guestWebsite" class="form-label">Website/LinkedIn (Optional)</label>
                                    <input type="url" class="form-control" id="guestWebsite" 
                                           placeholder="https://linkedin.com/in/yourname">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="guestLocation" class="form-label">Current Location</label>
                                    <input type="text" class="form-control" id="guestLocation" 
                                           placeholder="City, Country">
                                    <div class="form-text">Helps us find faculty in your region</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="preferredContact" class="form-label">Preferred Contact Method</label>
                                    <select class="form-select" id="preferredContact">
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="either">Either Email or Phone</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="guestBio" class="form-label">Brief Background & Goals</label>
                            <textarea class="form-control" id="guestBio" rows="3" 
                                      placeholder="Tell us about your academic background, research interests, and what you're looking for in a faculty mentor or research supervisor..."></textarea>
                            <div class="form-text">This helps us provide more targeted recommendations</div>
                        </div>
                        
                        <!-- Privacy Notice -->
                        <div class="alert alert-light border border-secondary">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                <strong>Privacy Notice:</strong> Your contact information will only be used to send you analysis results and follow-up communications. 
                                We do not share your information with third parties. You can opt out of future communications at any time.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Academic Field Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>Academic Field Selection
                    </h5>
                </div>
                <div class="card-body field-selection">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="broadCategory" class="form-label">Broad Academic Category *</label>
                                <select class="form-select" id="broadCategory" onchange="updateNarrowFields()" required>
                                    <option value="">Select your broad academic category</option>
                                    <option value="health_sciences">Health Sciences & Medicine</option>
                                    <option value="life_sciences">Life Sciences & Biology</option>
                                    <option value="physical_sciences">Physical Sciences</option>
                                    <option value="engineering">Engineering & Technology</option>
                                    <option value="computer_science">Computer Science & Information Technology</option>
                                    <option value="mathematics">Mathematics & Statistics</option>
                                    <option value="social_sciences">Social Sciences</option>
                                    <option value="humanities">Humanities & Liberal Arts</option>
                                    <option value="business">Business & Economics</option>
                                    <option value="education">Education & Pedagogy</option>
                                    <option value="environmental">Environmental Sciences</option>
                                    <option value="interdisciplinary">Interdisciplinary Studies</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="narrowField" class="form-label">Specific Field/Specialty *</label>
                                <select class="form-select" id="narrowField" required>
                                    <option value="">First select a broad category</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="researchKeywords" class="form-label">Research Keywords</label>
                                <input type="text" class="form-control" id="researchKeywords" 
                                       placeholder="e.g., machine learning, cancer biology, quantum computing"
                                       value="{{ current_user.field_of_study if current_user.is_authenticated else '' }}">
                                <div class="form-text">Separate multiple keywords with commas</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="careerGoals" class="form-label">Career Goals</label>
                                <select class="form-select" id="careerGoals">
                                    <option value="">Select your primary career goal</option>
                                    <option value="academic_research">Academic Research Career</option>
                                    <option value="industry_rd">Industry R&D</option>
                                    <option value="clinical_practice">Clinical Practice</option>
                                    <option value="entrepreneurship">Entrepreneurship</option>
                                    <option value="policy_government">Policy & Government</option>
                                    <option value="consulting">Consulting</option>
                                    <option value="teaching">Teaching & Education</option>
                                    <option value="non_profit">Non-profit & NGOs</option>
                                    <option value="undecided">Still Exploring</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="specificInterests" class="form-label">Specific Research Interests & Methodologies</label>
                        <textarea class="form-control" id="specificInterests" rows="3" 
                                  placeholder="Describe your specific research interests, preferred methodologies, theoretical frameworks, or any particular approaches you're interested in exploring..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CV Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-upload me-2"></i>Upload Your CV/Resume
                    </h5>
                </div>
                <div class="card-body">
                    <div id="uploadArea" class="upload-area" onclick="document.getElementById('cvFile').click()">
                        <div class="file-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h5>Drag & Drop your CV here</h5>
                        <p class="text-muted mb-3">or click to browse files</p>
                        <p class="small text-muted">
                            Supported formats: PDF, DOCX (Max size: 10MB)
                        </p>
                        <input type="file" id="cvFile" accept=".pdf,.doc,.docx" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    
                    <div id="fileInfo" class="mt-3" style="display: none;">
                        <div class="alert alert-success d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="fileName"></span>
                            <button type="button" class="btn-close ms-auto" onclick="clearFile()">Choose Different File</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Service Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>Choose Your AI Assistant
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('claude')">
                                <div class="card-body text-center">
                                    <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                                    <h6>Claude (Anthropic)</h6>
                                    <p class="small text-muted">Advanced reasoning and analysis</p>
                                    <span class="category-badge">Recommended</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('gpt')">
                                <div class="card-body text-center">
                                    <i class="fas fa-lightbulb fa-2x text-success mb-2"></i>
                                    <h6>ChatGPT (OpenAI)</h6>
                                    <p class="small text-muted">Creative and comprehensive</p>
                                    <span class="category-badge">Popular</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('gemini')">
                                <div class="card-body text-center">
                                    <i class="fas fa-gem fa-2x text-warning mb-2"></i>
                                    <h6>Gemini (Google)</h6>
                                    <p class="small text-muted">Multi-modal understanding</p>
                                    <span class="category-badge">Versatile</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('grok')">
                                <div class="card-body text-center">
                                    <i class="fas fa-rocket fa-2x text-info mb-2"></i>
                                    <h6>Grok (xAI)</h6>
                                    <p class="small text-muted">Real-time and innovative</p>
                                    <span class="category-badge">Latest</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="selectedAI" value="">
                </div>
            </div>
        </div>
    </div>

    <!-- Payment & API Options -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>Analysis Options
                    </h5>
                    <p class="text-muted mb-0 small">Choose the option that best fits your needs and budget</p>
                </div>
                <div class="card-body">
                    <!-- Free Option -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card ai-service-card h-100" onclick="selectAnalysisOption('api_key')">
                                <div class="card-body text-center">
                                    <i class="fas fa-key fa-2x text-success mb-3"></i>
                                    <h5>Use Your Own API Key</h5>
                                    <p class="text-muted">Bring your own Claude, ChatGPT, or Gemini API key</p>
                                    <div class="mb-3" id="apiKeyInput" style="display: none;">
                                        <input type="text" class="form-control" id="apiKey" placeholder="Enter your API key" onclick="event.stopPropagation()">
                                    </div>
                                    <div class="display-6 fw-bold text-success">FREE</div>
                                    <div class="badge bg-success mb-2">UNLIMITED ANALYSES</div>
                                    <p class="small text-muted">Perfect for tech-savvy users • You control the costs</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis Tiers -->
                    <h6 class="text-primary mb-3"><i class="fas fa-robot me-2"></i>AI-Powered Analysis</h6>
                    <div class="row g-3 mb-4">
                        <!-- Single Analysis -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAnalysisOption('single_analysis')">
                                <div class="card-body text-center">
                                    <i class="fas fa-lightning-bolt fa-2x text-primary mb-3"></i>
                                    <h6>Single Analysis</h6>
                                    <div class="display-6 fw-bold text-primary">$4</div>
                                    <div class="text-muted small">CAD</div>
                                    <div class="badge bg-light text-dark mb-2">ONE-TIME</div>
                                    <ul class="list-unstyled small text-start">
                                        <li><i class="fas fa-check text-success me-1"></i> CV analysis</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Top 5 faculty matches</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Research alignment score</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Contact suggestions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 3-Pack Bundle -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card recommended h-100" onclick="selectAnalysisOption('triple_pack')">
                                <div class="card-body text-center">
                                    <i class="fas fa-layer-group fa-2x text-primary mb-3"></i>
                                    <h6>3-Analysis Pack</h6>
                                    <div class="display-6 fw-bold text-primary">$10</div>
                                    <div class="text-muted small">CAD • Save 33%</div>
                                    <div class="badge bg-success mb-2">MOST POPULAR</div>
                                    <ul class="list-unstyled small text-start">
                                        <li><i class="fas fa-check text-success me-1"></i> 3 complete analyses</li>
                                        <li><i class="fas fa-check text-success me-1"></i> $3.33 per analysis</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Perfect for grad school</li>
                                        <li><i class="fas fa-check text-success me-1"></i> 6-month validity</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 5-Pack Bundle -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAnalysisOption('five_pack')">
                                <div class="card-body text-center">
                                    <i class="fas fa-boxes fa-2x text-primary mb-3"></i>
                                    <h6>5-Analysis Pack</h6>
                                    <div class="display-6 fw-bold text-primary">$15</div>
                                    <div class="text-muted small">CAD • Save 40%</div>
                                    <div class="badge bg-info mb-2">BEST VALUE</div>
                                    <ul class="list-unstyled small text-start">
                                        <li><i class="fas fa-check text-success me-1"></i> 5 complete analyses</li>
                                        <li><i class="fas fa-check text-success me-1"></i> $3.00 per analysis</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Comprehensive search</li>
                                        <li><i class="fas fa-check text-success me-1"></i> 1-year validity</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Unlimited -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAnalysisOption('monthly_unlimited')">
                                <div class="card-body text-center">
                                    <i class="fas fa-infinity fa-2x text-primary mb-3"></i>
                                    <h6>Monthly Unlimited</h6>
                                    <div class="display-6 fw-bold text-primary">$19</div>
                                    <div class="text-muted small">CAD/month</div>
                                    <div class="badge bg-warning mb-2">POWER USER</div>
                                    <ul class="list-unstyled small text-start">
                                        <li><i class="fas fa-check text-success me-1"></i> Unlimited analyses</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Cancel anytime</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Priority processing</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Advanced features</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expert Review Tiers -->
                    <h6 class="text-warning mb-3"><i class="fas fa-user-graduate me-2"></i>Expert Manual Review</h6>
                    <div class="row g-3 mb-4">
                        <!-- Basic Expert Review -->
                        <div class="col-lg-4">
                            <div class="card ai-service-card h-100" onclick="selectAnalysisOption('expert_basic')">
                                <div class="card-body text-center">
                                    <i class="fas fa-user-check fa-2x text-warning mb-3"></i>
                                    <h6>Basic Expert Review</h6>
                                    <div class="display-6 fw-bold text-warning">$29</div>
                                    <div class="text-muted small">CAD</div>
                                    <div class="badge bg-warning mb-2">PROFESSIONAL</div>
                                    <ul class="list-unstyled small text-start">
                                        <li><i class="fas fa-check text-success me-1"></i> Manual CV analysis</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Top 10 faculty matches</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Research fit assessment</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Contact strategy advice</li>
                                        <li><i class="fas fa-clock text-muted me-1"></i> 3-5 business days</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Premium Expert Review -->
                        <div class="col-lg-4">
                            <div class="card ai-service-card h-100" onclick="selectAnalysisOption('expert_premium')">
                                <div class="card-body text-center">
                                    <i class="fas fa-star fa-2x text-warning mb-3"></i>
                                    <h6>Premium Expert Review</h6>
                                    <div class="display-6 fw-bold text-warning">$49</div>
                                    <div class="text-muted small">CAD</div>
                                    <div class="badge bg-danger mb-2">PREMIUM</div>
                                    <ul class="list-unstyled small text-start">
                                        <li><i class="fas fa-check text-success me-1"></i> Everything in Basic</li>
                                        <li><i class="fas fa-video text-success me-1"></i> 30-min video consultation</li>
                                        <li><i class="fas fa-calendar text-success me-1"></i> Personalized timeline</li>
                                        <li><i class="fas fa-envelope text-success me-1"></i> 1-week email support</li>
                                        <li><i class="fas fa-clock text-muted me-1"></i> 2-3 business days</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- VIP Package -->
                        <div class="col-lg-4">
                            <div class="card ai-service-card h-100" onclick="selectAnalysisOption('expert_vip')">
                                <div class="card-body text-center">
                                    <i class="fas fa-crown fa-2x text-warning mb-3"></i>
                                    <h6>VIP Package</h6>
                                    <div class="display-6 fw-bold text-warning">$99</div>
                                    <div class="text-muted small">CAD</div>
                                    <div class="badge bg-dark mb-2">VIP</div>
                                    <ul class="list-unstyled small text-start">
                                        <li><i class="fas fa-check text-success me-1"></i> Everything in Premium</li>
                                        <li><i class="fas fa-microphone text-success me-1"></i> Mock interview session</li>
                                        <li><i class="fas fa-handshake text-success me-1"></i> Custom intro emails</li>
                                        <li><i class="fas fa-graduation-cap text-success me-1"></i> 1-month coaching</li>
                                        <li><i class="fas fa-clock text-muted me-1"></i> 24-48 hours</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Promotional Banner -->
                    <div class="alert alert-info border-0 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="alert-heading mb-1">
                                    <i class="fas fa-gift me-2"></i>Early Bird Special - Limited Time!
                                </h6>
                                <p class="mb-0 small">First 1000 users get 50% off all paid options. Use code: <strong>EARLYBIRD50</strong></p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <div class="badge bg-danger fs-6">50% OFF</div>
                            </div>
                        </div>
                    </div>

                    <!-- Money-back Guarantee -->
                    <div class="text-center">
                        <div class="d-inline-flex align-items-center text-muted small">
                            <i class="fas fa-shield-alt text-success me-2"></i>
                            30-day money-back guarantee • Over 1000 students helped • Average 40% increase in interview rates
                        </div>
                    </div>
                    
                    <input type="hidden" id="selectedAnalysisOption" value="triple_pack">
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Method Selection -->
    <div class="row mb-4" id="paymentMethodSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-wallet me-2"></i>Payment Method
                    </h5>
                    <p class="text-muted mb-0 small">Choose your preferred payment method for secure and fast transactions</p>
                </div>
                <div class="card-body">
                    <!-- Payment Method Options -->
                    <div class="row g-3">
                        <!-- Credit Card Payment -->
                        <div class="col-md-6">
                            <div class="card payment-method-card h-100" onclick="selectPaymentMethod('credit_card')">
                                <div class="card-body text-center">
                                    <i class="fas fa-credit-card fa-2x text-primary mb-3"></i>
                                    <h6>Credit Card</h6>
                                    <p class="text-muted small mb-3">Visa, MasterCard, Amex</p>
                                    <div class="payment-features">
                                        <div class="badge bg-success mb-2">INSTANT</div>
                                        <ul class="list-unstyled small text-start">
                                            <li><i class="fas fa-check text-success me-1"></i> Immediate access</li>
                                            <li><i class="fas fa-check text-success me-1"></i> Secure SSL encryption</li>
                                            <li><i class="fas fa-check text-success me-1"></i> Auto-refund protection</li>
                                            <li><i class="fas fa-check text-success me-1"></i> Receipt via email</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cryptocurrency Payment -->
                        <div class="col-md-6">
                            <div class="card payment-method-card h-100" onclick="selectPaymentMethod('cryptocurrency')">
                                <div class="card-body text-center">
                                    <i class="fab fa-bitcoin fa-2x text-warning mb-3"></i>
                                    <h6>Cryptocurrency</h6>
                                    <p class="text-muted small mb-3">Bitcoin, Ethereum, USDC & more</p>
                                    <div class="payment-features">
                                        <div class="badge bg-warning text-dark mb-2">PRIVATE</div>
                                        <ul class="list-unstyled small text-start">
                                            <li><i class="fas fa-check text-success me-1"></i> Anonymous payments</li>
                                            <li><i class="fas fa-check text-success me-1"></i> No personal info needed</li>
                                            <li><i class="fas fa-check text-success me-1"></i> Lower fees (0.5-1%)</li>
                                            <li><i class="fas fa-check text-success me-1"></i> Global accessibility</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cryptocurrency Selection (Hidden initially) -->
                    <div id="cryptoSelection" class="mt-4" style="display: none;">
                        <h6 class="text-primary mb-3"><i class="fab fa-bitcoin me-2"></i>Select Cryptocurrency</h6>
                        <div class="row g-2" id="cryptoCurrencies">
                            <!-- Will be populated dynamically -->
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label small">Payment Provider</label>
                                <select class="form-select" id="cryptoProvider">
                                    <option value="coinbase_commerce">Coinbase Commerce (Recommended)</option>
                                    <option value="nowpayments">NOWPayments</option>
                                    <option value="coingate">CoinGate</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Estimated Total</label>
                                <div class="form-control-plaintext">
                                    <span id="cryptoAmount">Loading...</span>
                                    <small class="text-muted d-block">Exchange rate updates every 5 minutes</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="selectedPaymentMethod" value="">
                    <input type="hidden" id="selectedCryptoCurrency" value="">
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Button -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-primary btn-lg px-5" onclick="startAnalysis()">
                <i class="fas fa-magic me-2"></i>
                Start Faculty Matching Analysis
            </button>
            <p class="text-muted mt-2 small">
                Get personalized recommendations based on your CV and research interests
            </p>
        </div>
    </div>

    <!-- Results Section (Hidden initially) -->
    <div id="resultsSection" class="row" style="display: none;">
        <div class="col-12">
            <div class="analysis-result">
                <h5>
                    <i class="fas fa-chart-line me-2"></i>Analysis Results
                </h5>
                <div id="analysisContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function displayResults(results) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('analysisContent');
    
    if (!results || !results.cv_summary) {
        resultsContent.innerHTML = '<div class="alert alert-warning">No analysis results received.</div>';
        resultsSection.style.display = 'block';
        return;
    }
    
    const { cv_summary, matching_faculty, recommendations } = results;
    
    let html = `
        <!-- CV Analysis Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt text-primary me-2"></i>
                    CV Analysis Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Academic Profile</h6>
                        <p><strong>Field:</strong> ${cv_summary.academic_field || 'Not specified'}</p>
                        <p><strong>Career Stage:</strong> ${cv_summary.career_stage || 'Not specified'}</p>
                        <p><strong>Education Level:</strong> ${cv_summary.education_level || 'Not specified'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Research Keywords</h6>
                        <div class="keywords-container">
                            ${(cv_summary.research_keywords || []).map(keyword => 
                                `<span class="badge bg-primary me-1 mb-1">${keyword}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Summary</h6>
                        <p class="text-muted">${cv_summary.summary || 'No summary available'}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Faculty Recommendations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users text-success me-2"></i>
                    Top Faculty Recommendations (${matching_faculty.length} found)
                </h5>
            </div>
            <div class="card-body">
                ${recommendations.summary ? `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ${recommendations.summary}
                    </div>
                ` : ''}
                
                ${recommendations.top_recommendations && recommendations.top_recommendations.length > 0 ? `
                    <div class="recommendations-list">
                        ${recommendations.top_recommendations.map((rec, index) => `
                            <div class="recommendation-card card mb-3 border-start border-primary border-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="card-title">
                                                ${index + 1}. ${rec.faculty_name}
                                                <span class="badge bg-secondary ms-2">${rec.university}</span>
                                            </h6>
                                            <p class="card-text">${rec.reasoning}</p>
                                            <div class="research-alignment">
                                                <small class="text-muted">
                                                    <strong>Research Alignment:</strong> ${rec.research_alignment}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="contact-actions">
                                                ${rec.contact_info.email ? `
                                                    <a href="mailto:${rec.contact_info.email}" class="btn btn-outline-primary btn-sm mb-2 w-100">
                                                        <i class="fas fa-envelope me-1"></i>Send Email
                                                    </a>
                                                ` : ''}
                                                ${rec.contact_info.website ? `
                                                    <a href="${rec.contact_info.website}" target="_blank" class="btn btn-outline-secondary btn-sm mb-2 w-100">
                                                        <i class="fas fa-globe me-1"></i>Website
                                                    </a>
                                                ` : ''}
                                                ${rec.contact_info.google_scholar ? `
                                                    <a href="${rec.contact_info.google_scholar}" target="_blank" class="btn btn-outline-info btn-sm mb-2 w-100">
                                                        <i class="fas fa-graduation-cap me-1"></i>Google Scholar
                                                    </a>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="next-steps mt-3">
                                        <small class="text-muted">
                                            <strong>Next Steps:</strong> ${rec.next_steps}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
        
        <!-- General Next Steps -->
        ${recommendations.general_next_steps && recommendations.general_next_steps.length > 0 ? `
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list-check text-warning me-2"></i>
                        Recommended Next Steps
                    </h5>
                </div>
                <div class="card-body">
                    <ol class="next-steps-list">
                        ${recommendations.general_next_steps.map(step => `
                            <li class="mb-2">${step}</li>
                        `).join('')}
                    </ol>
                </div>
            </div>
        ` : ''}
        
        <!-- Additional Advice -->
        ${recommendations.additional_advice ? `
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb text-info me-2"></i>
                        Additional Advice
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">${recommendations.additional_advice}</p>
                </div>
            </div>
        ` : ''}
        
        <!-- All Matching Faculty -->
        ${matching_faculty.length > 5 ? `
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search text-secondary me-2"></i>
                        All Matching Faculty (${matching_faculty.length} total)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Position</th>
                                    <th>University</th>
                                    <th>Department</th>
                                    <th>Match Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${matching_faculty.map(faculty => `
                                    <tr>
                                        <td><strong>${faculty.name}</strong></td>
                                        <td>${faculty.position || 'Faculty'}</td>
                                        <td>${faculty.university_name}</td>
                                        <td>${faculty.department || 'N/A'}</td>
                                        <td>
                                            <span class="badge bg-${faculty.match_score > 3 ? 'success' : faculty.match_score > 1 ? 'warning' : 'secondary'}">
                                                ${faculty.match_score || 0}
                                            </span>
                                        </td>
                                        <td>
                                            ${faculty.uni_email ? `
                                                <a href="mailto:${faculty.uni_email}" class="btn btn-sm btn-outline-primary me-1" title="Send Email">
                                                    <i class="fas fa-envelope"></i>
                                                </a>
                                            ` : ''}
                                            ${faculty.website ? `
                                                <a href="${faculty.website}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Visit Website">
                                                    <i class="fas fa-globe"></i>
                                                </a>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        ` : ''}
    `;
    
    resultsContent.innerHTML = html;
    resultsSection.style.display = 'block';
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Show success toast
    FacultyFinder.utils.showToast('CV analysis completed successfully!', 'success', 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set default analysis option (3-Pack Bundle - most popular)
    selectAnalysisOption('triple_pack');
});

// File selection variables
let selectedFile = null;

// Academic field mappings
const academicFields = {
    "health_sciences": [
        "Medicine/Medical Sciences", "Nursing", "Dentistry", "Pharmacy/Pharmacology", 
        "Public Health/Epidemiology", "Veterinary Medicine", "Physical Therapy", 
        "Occupational Therapy", "Speech-Language Pathology", "Clinical Psychology", 
        "Health Administration", "Medical Laboratory Science", "Radiologic Technology", 
        "Nutrition/Dietetics", "Health Informatics", "Biomedical Engineering", 
        "Medical Physics", "Pathology", "Immunology", "Microbiology", 
        "Parasitology", "Virology", "Oncology", "Cardiology", "Neurology", 
        "Psychiatry", "Pediatrics", "Geriatrics", "Emergency Medicine", 
        "Anesthesiology", "Surgery", "Orthopedics", "Ophthalmology", 
        "Dermatology", "Radiology", "Rehabilitation Sciences", "Global Health"
    ],
    "life_sciences": [
        "Biology/General Biology", "Biochemistry", "Molecular Biology", "Cell Biology", 
        "Genetics/Genomics", "Bioinformatics", "Biotechnology", "Ecology", 
        "Evolution", "Marine Biology", "Botany", "Zoology", "Entomology", 
        "Ornithology", "Mammalogy", "Herpetology", "Ichthyology", "Mycology", 
        "Microbiology", "Virology", "Bacteriology", "Physiology", "Anatomy", 
        "Neuroscience", "Behavioral Biology", "Conservation Biology", 
        "Environmental Biology", "Developmental Biology", "Synthetic Biology", 
        "Systems Biology", "Computational Biology", "Structural Biology"
    ],
    "physical_sciences": [
        "Physics", "Chemistry", "Astronomy/Astrophysics", "Earth Sciences/Geology", 
        "Atmospheric Sciences/Meteorology", "Oceanography", "Materials Science", 
        "Nanotechnology", "Theoretical Physics", "Experimental Physics", 
        "Quantum Physics", "Nuclear Physics", "Particle Physics", "Condensed Matter Physics", 
        "Optics/Photonics", "Acoustics", "Organic Chemistry", "Inorganic Chemistry", 
        "Physical Chemistry", "Analytical Chemistry", "Environmental Chemistry", 
        "Geochemistry", "Cosmology", "Planetary Science", "Seismology", 
        "Volcanology", "Mineralogy", "Petrology", "Crystallography"
    ],
    "engineering": [
        "Mechanical Engineering", "Electrical Engineering", "Civil Engineering", 
        "Chemical Engineering", "Aerospace Engineering", "Biomedical Engineering", 
        "Environmental Engineering", "Industrial Engineering", "Materials Engineering", 
        "Nuclear Engineering", "Petroleum Engineering", "Mining Engineering", 
        "Agricultural Engineering", "Food Engineering", "Ocean Engineering", 
        "Automotive Engineering", "Robotics Engineering", "Mechatronics", 
        "Systems Engineering", "Engineering Management", "Safety Engineering", 
        "Quality Engineering", "Manufacturing Engineering", "Process Engineering", 
        "Structural Engineering", "Geotechnical Engineering", "Transportation Engineering", 
        "Water Resources Engineering", "Engineering Physics"
    ],
    "computer_science": [
        "Computer Science/General", "Software Engineering", "Computer Engineering", 
        "Information Technology", "Information Systems", "Cybersecurity", 
        "Data Science", "Machine Learning", "Artificial Intelligence", 
        "Human-Computer Interaction", "Computer Graphics", "Computer Vision", 
        "Natural Language Processing", "Robotics", "Database Systems", 
        "Computer Networks", "Distributed Systems", "Operating Systems", 
        "Programming Languages", "Software Architecture", "Web Development", 
        "Mobile App Development", "Game Development", "DevOps", 
        "Cloud Computing", "Big Data", "Blockchain", "Quantum Computing", 
        "Information Security", "Digital Forensics", "Bioinformatics"
    ],
    "mathematics": [
        "Pure Mathematics", "Applied Mathematics", "Statistics", "Probability", 
        "Mathematical Modeling", "Computational Mathematics", "Operations Research", 
        "Actuarial Science", "Mathematical Physics", "Number Theory", 
        "Algebra", "Geometry", "Topology", "Analysis", "Differential Equations", 
        "Discrete Mathematics", "Combinatorics", "Graph Theory", "Logic", 
        "Set Theory", "Cryptography", "Financial Mathematics", "Biostatistics", 
        "Econometrics", "Mathematical Biology", "Optimization", "Numerical Analysis"
    ],
    "social_sciences": [
        "Psychology", "Sociology", "Anthropology", "Political Science", 
        "International Relations", "Economics", "Geography", "History", 
        "Archaeology", "Criminology", "Social Work", "Public Administration", 
        "Urban Planning", "Development Studies", "Gender Studies", 
        "Cultural Studies", "Media Studies", "Communication", "Linguistics", 
        "Philosophy", "Religious Studies", "Ethics", "Law/Legal Studies", 
        "Human Rights", "Peace Studies", "Conflict Resolution", "Public Policy", 
        "Demography", "Social Psychology", "Cognitive Psychology", "Clinical Psychology"
    ],
    "humanities": [
        "Literature", "History", "Philosophy", "Languages/Linguistics", 
        "Art History", "Music", "Theater/Drama", "Film Studies", 
        "Creative Writing", "Translation Studies", "Classical Studies", 
        "Medieval Studies", "Renaissance Studies", "Modern Languages", 
        "Comparative Literature", "Cultural Studies", "Religious Studies", 
        "Theology", "Ethics", "Aesthetics", "Rhetoric", "Library Science", 
        "Museum Studies", "Digital Humanities", "Heritage Studies"
    ],
    "business": [
        "Business Administration", "Management", "Marketing", "Finance", 
        "Accounting", "Economics", "Entrepreneurship", "International Business", 
        "Operations Management", "Human Resources", "Organizational Behavior", 
        "Strategic Management", "Supply Chain Management", "Project Management", 
        "Business Analytics", "E-commerce", "Digital Marketing", "Brand Management", 
        "Investment Management", "Corporate Finance", "Risk Management", 
        "Real Estate", "Insurance", "Banking", "Consulting", "Business Ethics", 
        "Sustainable Business", "Innovation Management"
    ],
    "education": [
        "Education/General", "Curriculum and Instruction", "Educational Psychology", 
        "Educational Administration", "Special Education", "Early Childhood Education", 
        "Elementary Education", "Secondary Education", "Higher Education", 
        "Adult Education", "Distance Learning", "Educational Technology", 
        "Language Education", "Mathematics Education", "Science Education", 
        "Social Studies Education", "Art Education", "Music Education", 
        "Physical Education", "Health Education", "Vocational Education", 
        "Teacher Training", "Educational Assessment", "Educational Policy", 
        "Comparative Education", "International Education"
    ],
    "environmental": [
        "Environmental Science", "Environmental Studies", "Ecology", 
        "Conservation Biology", "Environmental Chemistry", "Environmental Physics", 
        "Environmental Engineering", "Climate Science", "Sustainability Studies", 
        "Natural Resource Management", "Wildlife Management", "Forestry", 
        "Environmental Policy", "Environmental Law", "Environmental Economics", 
        "Renewable Energy", "Environmental Health", "Pollution Control", 
        "Waste Management", "Water Resources", "Soil Science", "Atmospheric Science", 
        "Environmental Monitoring", "Environmental Impact Assessment", 
        "Green Technology", "Carbon Management"
    ],
    "interdisciplinary": [
        "Cognitive Science", "Neuroscience", "Bioinformatics", "Computational Biology", 
        "Science, Technology & Society", "History of Science", "Philosophy of Science", 
        "Bioethics", "Medical Humanities", "Digital Humanities", "Environmental Humanities", 
        "Science Communication", "Technology Studies", "Innovation Studies", 
        "Future Studies", "Complexity Science", "Network Science", "Data Science", 
        "Sustainability Science", "Global Studies", "Area Studies", "Ethnic Studies", 
        "Women's Studies", "Disability Studies", "Science Policy", "Technology Policy"
    ]
};

function updateNarrowFields() {
    const broadCategory = document.getElementById('broadCategory').value;
    const narrowField = document.getElementById('narrowField');
    
    narrowField.innerHTML = '<option value="">Select a specific field</option>';
    
    if (broadCategory && academicFields[broadCategory]) {
        academicFields[broadCategory].forEach(field => {
            const option = document.createElement('option');
            option.value = field.toLowerCase().replace(/[^a-z0-9]/g, '_');
            option.textContent = field;
            narrowField.appendChild(option);
        });
    }
}

function selectAI(aiService) {
    // Remove selected class from all cards
    document.querySelectorAll('.ai-service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    event.target.closest('.ai-service-card').classList.add('selected');
    
    // Update hidden input
    document.getElementById('selectedAI').value = aiService;
}

function selectAnalysisOption(optionValue) {
    // Remove active class from all cards
    document.querySelectorAll('.ai-service-card').forEach(card => {
        card.classList.remove('selected', 'border-primary');
    });
    
    // Add active class to selected card
    const selectedCard = document.querySelector(`[onclick*="${optionValue}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected', 'border-primary');
    }
    
    // Store selected option
    document.getElementById('selectedAnalysisOption').value = optionValue;
    
    // Show/hide API key input
    const apiKeySection = document.getElementById('apiKeyInput');
    if (apiKeySection) {
        if (optionValue === 'api_key') {
            apiKeySection.style.display = 'block';
            apiKeySection.querySelector('input').required = true;
        } else {
            apiKeySection.style.display = 'none';
            apiKeySection.querySelector('input').required = false;
        }
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        // Validate file type
        const allowedTypes = [
            'application/pdf',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/msword'
        ];
        
        if (!allowedTypes.includes(file.type)) {
            alert('Please select a PDF or Word document.');
            return;
        }
        
        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            return;
        }
        
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileInfo').style.display = 'block';
        
        // Update upload area
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.innerHTML = `
            <div class="file-icon" style="color: #28a745;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h5 style="color: #28a745;">File Selected</h5>
            <p class="text-muted">${file.name}</p>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFile()">Choose Different File</button>
        `;
    }
}

function clearFile() {
    selectedFile = null;
    document.getElementById('cvFile').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    
    // Reset upload area
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.innerHTML = `
        <div class="file-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h5>Drag & Drop your CV here</h5>
        <p class="text-muted mb-3">or click to browse files</p>
        <p class="small text-muted">
            Supported formats: PDF, DOCX (Max size: 10MB)
        </p>
    `;
}

function startAnalysis() {
    // Validate required fields
    const broadCategory = document.getElementById('broadCategory').value;
    const narrowField = document.getElementById('narrowField').value;
    const selectedAI = document.querySelector('input[name="ai_service"]:checked');
    const selectedAnalysisOption = document.getElementById('selectedAnalysisOption').value;
    
    if (!selectedFile) {
        alert('Please upload your CV first.');
        return;
    }
    
    if (!broadCategory || !narrowField) {
        alert('Please select both broad category and specific field.');
        return;
    }
    
    if (!selectedAI) {
        alert('Please select an AI service.');
        return;
    }
    
    if (selectedAnalysisOption === 'api_key') {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Please enter your API key or choose a different payment option.');
            return;
        }
    }
    
    // Collect all form data
    const formData = new FormData();
    formData.append('cv_file', selectedFile);
    formData.append('ai_service', selectedAI.value);
    formData.append('broad_category', broadCategory);
    formData.append('narrow_field', narrowField);
    formData.append('analysis_option', selectedAnalysisOption);
    
    // Add user profile data based on authentication status
    var isAuthenticated = {% if current_user.is_authenticated %}true{% else %}false{% endif %};
    
    if (isAuthenticated) {
        formData.append('user_name', document.getElementById('userName').value);
        formData.append('user_institution', document.getElementById('userInstitution').value);
        formData.append('user_level', document.getElementById('userLevel').value);
        formData.append('user_website', document.getElementById('userWebsite').value);
        formData.append('user_orcid', document.getElementById('userOrcid').value);
        formData.append('user_bio', document.getElementById('userBio').value);
    } else {
        // Add guest user data
        formData.append('guest_name', document.getElementById('guestName').value);
        formData.append('guest_email', document.getElementById('guestEmail').value);
        formData.append('guest_phone', document.getElementById('guestPhone').value);
        formData.append('guest_institution', document.getElementById('guestInstitution').value);
        formData.append('guest_level', document.getElementById('guestLevel').value);
        formData.append('guest_website', document.getElementById('guestWebsite').value);
        formData.append('guest_location', document.getElementById('guestLocation').value);
        formData.append('guest_contact_method', document.getElementById('preferredContact').value);
        formData.append('guest_bio', document.getElementById('guestBio').value);
    }
    
    formData.append('research_keywords', document.getElementById('researchKeywords').value);
    formData.append('career_goals', document.getElementById('careerGoals').value);
    formData.append('specific_interests', document.getElementById('specificInterests').value);
    
    if (selectedAnalysisOption === 'api_key') {
        formData.append('api_key', document.getElementById('apiKey').value);
    }
    
    // Show loading state
    const button = document.querySelector('button[onclick="startAnalysis()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
    button.disabled = true;
    
    // Submit the form
    fetch('/api/analyze-cv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResults(data.results);
        } else {
            alert('Analysis failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during analysis. Please try again.');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        uploadArea.classList.add('dragover');
    }
    
    function unhighlight(e) {
        uploadArea.classList.remove('dragover');
    }
    
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            const event = { target: { files: files } };
            handleFileSelect(event);
        }
    }

    // Payment Method Functions
    function selectPaymentMethod(method) {
        // Remove previous selections
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.classList.remove('border-primary', 'selected');
        });
        
        // Select the clicked method
        event.target.closest('.payment-method-card').classList.add('border-primary', 'selected');
        document.getElementById('selectedPaymentMethod').value = method;
        
        if (method === 'cryptocurrency') {
            document.getElementById('cryptoSelection').style.display = 'block';
            loadCryptocurrencies();
        } else {
            document.getElementById('cryptoSelection').style.display = 'none';
        }
    }

    function loadCryptocurrencies() {
        fetch('/api/crypto/currencies')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('cryptoCurrencies');
                container.innerHTML = '';
                
                if (data.currencies) {
                    data.currencies.forEach(currency => {
                        const cryptoCard = document.createElement('div');
                        cryptoCard.className = 'col-lg-2 col-md-3 col-sm-4 col-6';
                        cryptoCard.innerHTML = `
                            <div class="card crypto-currency-card h-100" onclick="selectCryptoCurrency('${currency.symbol}')">
                                <div class="card-body text-center p-2">
                                    <img src="${currency.logo_url}" alt="${currency.symbol}" 
                                         style="width: 32px; height: 32px;" class="mb-2">
                                    <h6 class="mb-1">${currency.symbol}</h6>
                                    <small class="text-muted">${currency.name}</small>
                                    ${currency.is_stablecoin ? '<div class="badge bg-success mt-1 small">Stable</div>' : ''}
                                </div>
                            </div>
                        `;
                        container.appendChild(cryptoCard);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading cryptocurrencies:', error);
                document.getElementById('cryptoCurrencies').innerHTML = 
                    '<div class="col-12"><div class="alert alert-warning">Failed to load cryptocurrencies</div></div>';
            });
    }

    function selectCryptoCurrency(symbol) {
        // Remove previous selections
        document.querySelectorAll('.crypto-currency-card').forEach(card => {
            card.classList.remove('border-primary', 'selected');
        });
        
        // Select the clicked currency
        event.target.closest('.crypto-currency-card').classList.add('border-primary', 'selected');
        document.getElementById('selectedCryptoCurrency').value = symbol;
        
        // Update amount display
        updateCryptoAmount(symbol);
    }

    function updateCryptoAmount(symbol) {
        const selectedOption = document.getElementById('selectedAnalysisOption').value;
        const priceMap = {
            'single_analysis': 400,  // $4.00 in cents
            'triple_pack': 1000,     // $10.00 in cents
            'five_pack': 1500,       // $15.00 in cents
            'monthly_unlimited': 1900, // $19.00 in cents
            'expert_basic': 2900,    // $29.00 in cents
            'expert_premium': 4900,  // $49.00 in cents
            'expert_vip': 9900       // $99.00 in cents
        };
        
        const amountCAD = priceMap[selectedOption] || 1000;
        
        fetch(`/api/crypto/exchange-rate/${symbol}?fiat=CAD`)
            .then(response => response.json())
            .then(data => {
                const cryptoAmount = (amountCAD / 100) / data.rate;
                document.getElementById('cryptoAmount').innerHTML = `
                    <strong>${cryptoAmount.toFixed(8)} ${symbol}</strong>
                    <br><small class="text-muted">≈ $${(amountCAD / 100).toFixed(2)} CAD</small>
                `;
            })
            .catch(error => {
                console.error('Error getting exchange rate:', error);
                document.getElementById('cryptoAmount').innerHTML = 
                    '<span class="text-danger">Rate unavailable</span>';
            });
    }

    // Update the selectAnalysisOption function to show payment methods for paid options
    function selectAnalysisOption(option) {
        // Remove previous selections
        document.querySelectorAll('.ai-service-card').forEach(card => {
            card.classList.remove('border-primary', 'selected');
        });
        
        // Select the clicked option
        event.target.closest('.ai-service-card').classList.add('border-primary', 'selected');
        document.getElementById('selectedAnalysisOption').value = option;
        
        // Show/hide payment method selection
        const paymentSection = document.getElementById('paymentMethodSection');
        if (option === 'api_key') {
            paymentSection.style.display = 'none';
            document.getElementById('apiKeyInput').style.display = 'block';
        } else {
            paymentSection.style.display = 'block';
            document.getElementById('apiKeyInput').style.display = 'none';
            
            // Update crypto amount if crypto is selected
            const selectedCrypto = document.getElementById('selectedCryptoCurrency').value;
            if (selectedCrypto) {
                updateCryptoAmount(selectedCrypto);
            }
        }
    }

    // Cryptocurrency Payment Processing
    function processCryptoPayment() {
        const formData = {
            amount_cad: getAnalysisPrice(),
            service_type: 'ai_analysis',
            currency: document.getElementById('selectedCryptoCurrency').value,
            provider: document.getElementById('cryptoProvider').value,
            analysis_option: document.getElementById('selectedAnalysisOption').value,
            ai_service: document.querySelector('input[name="aiService"]:checked').value
        };
        
        // Add user data
        var isAuthenticated = {% if current_user.is_authenticated %}true{% else %}false{% endif %};
        if (!isAuthenticated) {
            formData.guest_name = document.getElementById('guestName').value;
            formData.guest_email = document.getElementById('guestEmail').value;
        }
        
        fetch('/api/crypto/create-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to payment page
                window.location.href = `/crypto-payment/${data.payment.payment_id}`;
            } else {
                alert('Payment creation failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error creating crypto payment:', error);
            alert('Payment creation failed. Please try again.');
        });
    }

    function getAnalysisPrice() {
        const selectedOption = document.getElementById('selectedAnalysisOption').value;
        const priceMap = {
            'single_analysis': 400,
            'triple_pack': 1000,
            'five_pack': 1500,
            'monthly_unlimited': 1900,
            'expert_basic': 2900,
            'expert_premium': 4900,
            'expert_vip': 9900
        };
        return priceMap[selectedOption] || 1000;
    }
});
</script>
{% endblock %} 