{% extends "base.html" %}

{% block title %}AI Assistant - FacultyFinder{% endblock %}

{% block extra_css %}
<style>
.upload-area {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.upload-area:hover {
    border-color: #0056b3;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.upload-area.dragover {
    border-color: #28a745;
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.file-icon {
    font-size: 3rem;
    color: #007bff;
    margin-bottom: 1rem;
}

.pricing-card {
    transition: transform 0.2s;
    border: 2px solid transparent;
}

.pricing-card:hover {
    transform: translateY(-5px);
    border-color: #007bff;
}

.pricing-card.recommended {
    border-color: #28a745;
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.ai-service-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
}

.ai-service-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
}

.ai-service-card.selected {
    border-color: #007bff;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.profile-info {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 4px solid #ffc107;
}

.field-selection {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
}

.category-badge {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
}

.analysis-result {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-left: 4px solid #17a2b8;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-robot me-3"></i>AI Faculty Matching Assistant
            </h1>
            <p class="lead text-muted">
                Upload your CV and get personalized faculty recommendations powered by advanced AI
            </p>
        </div>
    </div>

    <!-- User Profile Information -->
    {% if current_user.is_authenticated %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card profile-info">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-user-circle me-2"></i>Your Profile Information
                        </h5>
                        <p class="text-muted small mb-3">
                            We'll use this information to provide better recommendations. You can update it below if needed.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="userName" 
                                           value="{{ current_user.get_full_name() }}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="userInstitution" class="form-label">Current Institution</label>
                                    <input type="text" class="form-control" id="userInstitution" 
                                           value="{{ current_user.institution }}" 
                                           placeholder="Enter your current institution">
                                </div>
                                <div class="mb-3">
                                    <label for="userLevel" class="form-label">Academic Level</label>
                                    <select class="form-select" id="userLevel">
                                        <option value="">Select your academic level</option>
                                        <option value="undergraduate" {{ 'selected' if current_user.academic_level == 'undergraduate' else '' }}>Undergraduate Student</option>
                                        <option value="graduate_masters" {{ 'selected' if current_user.academic_level == 'graduate' else '' }}>Graduate Student (Masters)</option>
                                        <option value="graduate_phd" {{ 'selected' if current_user.academic_level == 'graduate' else '' }}>Graduate Student (PhD)</option>
                                        <option value="postdoc" {{ 'selected' if current_user.academic_level == 'postdoc' else '' }}>Postdoctoral Researcher</option>
                                        <option value="faculty" {{ 'selected' if current_user.academic_level == 'faculty' else '' }}>Faculty Member</option>
                                        <option value="industry" {{ 'selected' if current_user.academic_level == 'other' else '' }}>Industry Professional</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="userEmail" 
                                           value="{{ current_user.email }}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="userWebsite" class="form-label">Website/Portfolio</label>
                                    <input type="url" class="form-control" id="userWebsite" 
                                           value="{{ current_user.website }}" 
                                           placeholder="https://your-website.com">
                                </div>
                                <div class="mb-3">
                                    <label for="userOrcid" class="form-label">ORCID ID</label>
                                    <input type="text" class="form-control" id="userOrcid" 
                                           value="{{ current_user.orcid }}" 
                                           placeholder="0000-0000-0000-0000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userBio" class="form-label">Research Interests & Background</label>
                            <textarea class="form-control" id="userBio" rows="3" 
                                      placeholder="Describe your research interests, academic background, and career goals...">{{ current_user.bio }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Guest User Information Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="fas fa-user-plus me-2"></i>Your Contact Information
                        </h5>
                        <p class="text-muted small mb-3">
                            Please provide your contact information so we can send you the AI analysis results and recommendations.
                        </p>
                        
                        <div class="alert alert-info d-flex align-items-center mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <strong>Want to save your information?</strong> 
                                <a href="/auth/register" class="alert-link">Create a free account</a> 
                                to save your preferences and access your analysis history.
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="guestName" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="guestName" 
                                           placeholder="Enter your full name" required>
                                    <div class="form-text">This will be used for personalized recommendations</div>
                                </div>
                                <div class="mb-3">
                                    <label for="guestEmail" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="guestEmail" 
                                           placeholder="your.email@example.com" required>
                                    <div class="form-text">We'll send your analysis results to this email</div>
                                </div>
                                <div class="mb-3">
                                    <label for="guestPhone" class="form-label">Phone Number (Optional)</label>
                                    <input type="tel" class="form-control" id="guestPhone" 
                                           placeholder="+1 (555) 123-4567">
                                    <div class="form-text">For follow-up consultation if needed</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="guestInstitution" class="form-label">Current Institution</label>
                                    <input type="text" class="form-control" id="guestInstitution" 
                                           placeholder="University or Organization">
                                </div>
                                <div class="mb-3">
                                    <label for="guestLevel" class="form-label">Academic Level *</label>
                                    <select class="form-select" id="guestLevel" required>
                                        <option value="">Select your academic level</option>
                                        <option value="high_school">High School Student</option>
                                        <option value="undergraduate">Undergraduate Student</option>
                                        <option value="graduate_masters">Graduate Student (Masters)</option>
                                        <option value="graduate_phd">Graduate Student (PhD)</option>
                                        <option value="postdoc">Postdoctoral Researcher</option>
                                        <option value="early_career">Early Career Researcher</option>
                                        <option value="faculty">Faculty Member</option>
                                        <option value="industry">Industry Professional</option>
                                        <option value="career_change">Career Changer</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="guestWebsite" class="form-label">Website/LinkedIn (Optional)</label>
                                    <input type="url" class="form-control" id="guestWebsite" 
                                           placeholder="https://linkedin.com/in/yourname">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="guestLocation" class="form-label">Current Location</label>
                                    <input type="text" class="form-control" id="guestLocation" 
                                           placeholder="City, Country">
                                    <div class="form-text">Helps us find faculty in your region</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="preferredContact" class="form-label">Preferred Contact Method</label>
                                    <select class="form-select" id="preferredContact">
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="either">Either Email or Phone</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="guestBio" class="form-label">Brief Background & Goals</label>
                            <textarea class="form-control" id="guestBio" rows="3" 
                                      placeholder="Tell us about your academic background, research interests, and what you're looking for in a faculty mentor or research supervisor..."></textarea>
                            <div class="form-text">This helps us provide more targeted recommendations</div>
                        </div>
                        
                        <!-- Privacy Notice -->
                        <div class="alert alert-light border border-secondary">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                <strong>Privacy Notice:</strong> Your contact information will only be used to send you analysis results and follow-up communications. 
                                We do not share your information with third parties. You can opt out of future communications at any time.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Academic Field Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>Academic Field Selection
                    </h5>
                </div>
                <div class="card-body field-selection">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="broadCategory" class="form-label">Broad Academic Category *</label>
                                <select class="form-select" id="broadCategory" onchange="updateNarrowFields()" required>
                                    <option value="">Select your broad academic category</option>
                                    <option value="health_sciences">Health Sciences & Medicine</option>
                                    <option value="life_sciences">Life Sciences & Biology</option>
                                    <option value="physical_sciences">Physical Sciences</option>
                                    <option value="engineering">Engineering & Technology</option>
                                    <option value="computer_science">Computer Science & Information Technology</option>
                                    <option value="mathematics">Mathematics & Statistics</option>
                                    <option value="social_sciences">Social Sciences</option>
                                    <option value="humanities">Humanities & Liberal Arts</option>
                                    <option value="business">Business & Economics</option>
                                    <option value="education">Education & Pedagogy</option>
                                    <option value="environmental">Environmental Sciences</option>
                                    <option value="interdisciplinary">Interdisciplinary Studies</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="narrowField" class="form-label">Specific Field/Specialty *</label>
                                <select class="form-select" id="narrowField" required>
                                    <option value="">First select a broad category</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="researchKeywords" class="form-label">Research Keywords</label>
                                <input type="text" class="form-control" id="researchKeywords" 
                                       placeholder="e.g., machine learning, cancer biology, quantum computing"
                                       value="{{ current_user.field_of_study if current_user.is_authenticated else '' }}">
                                <div class="form-text">Separate multiple keywords with commas</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="careerGoals" class="form-label">Career Goals</label>
                                <select class="form-select" id="careerGoals">
                                    <option value="">Select your primary career goal</option>
                                    <option value="academic_research">Academic Research Career</option>
                                    <option value="industry_rd">Industry R&D</option>
                                    <option value="clinical_practice">Clinical Practice</option>
                                    <option value="entrepreneurship">Entrepreneurship</option>
                                    <option value="policy_government">Policy & Government</option>
                                    <option value="consulting">Consulting</option>
                                    <option value="teaching">Teaching & Education</option>
                                    <option value="non_profit">Non-profit & NGOs</option>
                                    <option value="undecided">Still Exploring</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="specificInterests" class="form-label">Specific Research Interests & Methodologies</label>
                        <textarea class="form-control" id="specificInterests" rows="3" 
                                  placeholder="Describe your specific research interests, preferred methodologies, theoretical frameworks, or any particular approaches you're interested in exploring..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CV Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-upload me-2"></i>Upload Your CV/Resume
                    </h5>
                </div>
                <div class="card-body">
                    <div id="uploadArea" class="upload-area" onclick="document.getElementById('cvFile').click()">
                        <div class="file-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h5>Drag & Drop your CV here</h5>
                        <p class="text-muted mb-3">or click to browse files</p>
                        <p class="small text-muted">
                            Supported formats: PDF, DOCX (Max size: 10MB)
                        </p>
                        <input type="file" id="cvFile" accept=".pdf,.doc,.docx" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    
                    <div id="fileInfo" class="mt-3" style="display: none;">
                        <div class="alert alert-success d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="fileName"></span>
                            <button type="button" class="btn-close ms-auto" onclick="clearFile()">Choose Different File</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Service Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>Choose Your AI Assistant
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('claude')">
                                <div class="card-body text-center">
                                    <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                                    <h6>Claude (Anthropic)</h6>
                                    <p class="small text-muted">Advanced reasoning and analysis</p>
                                    <span class="category-badge">Recommended</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('gpt')">
                                <div class="card-body text-center">
                                    <i class="fas fa-lightbulb fa-2x text-success mb-2"></i>
                                    <h6>ChatGPT (OpenAI)</h6>
                                    <p class="small text-muted">Creative and comprehensive</p>
                                    <span class="category-badge">Popular</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('gemini')">
                                <div class="card-body text-center">
                                    <i class="fas fa-gem fa-2x text-warning mb-2"></i>
                                    <h6>Gemini (Google)</h6>
                                    <p class="small text-muted">Multi-modal understanding</p>
                                    <span class="category-badge">Versatile</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card ai-service-card h-100" onclick="selectAI('grok')">
                                <div class="card-body text-center">
                                    <i class="fas fa-rocket fa-2x text-info mb-2"></i>
                                    <h6>Grok (xAI)</h6>
                                    <p class="small text-muted">Real-time and innovative</p>
                                    <span class="category-badge">Latest</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="selectedAI" value="">
                </div>
            </div>
        </div>
    </div>

    <!-- Payment & API Options -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>Analysis Options
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Use Own API Key -->
                        <div class="col-lg-4">
                            <div class="card pricing-card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-key fa-2x text-success mb-3"></i>
                                    <h5>Use Your API Key</h5>
                                    <p class="text-muted">Use your own AI service API key</p>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="apiKey" placeholder="Enter your API key">
                                    </div>
                                    <div class="badge bg-success">FREE</div>
                                    <p class="small text-muted mt-2">You control the costs</p>
                                </div>
                            </div>
                        </div>

                        <!-- One-time Payment -->
                        <div class="col-lg-4">
                            <div class="card pricing-card recommended h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-lightning-bolt fa-2x text-primary mb-3"></i>
                                    <h5>Quick Analysis</h5>
                                    <p class="text-muted">One-time AI analysis</p>
                                    <div class="display-6 fw-bold text-primary">$5 CAD</div>
                                    <div class="badge bg-success mb-2">RECOMMENDED</div>
                                    <p class="small text-muted">Instant results with comprehensive analysis</p>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Review -->
                        <div class="col-lg-4">
                            <div class="card pricing-card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-user-check fa-2x text-warning mb-3"></i>
                                    <h5>Expert Review</h5>
                                    <p class="text-muted">Manual review by our academic advisors</p>
                                    <div class="display-6 fw-bold text-warning">$50 CAD</div>
                                    <div class="badge bg-warning">PREMIUM</div>
                                    <p class="small text-muted">3-5 business days • Detailed report</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="analysisOption" id="useApiKey" value="api_key">
                            <label class="form-check-label" for="useApiKey">Use My API Key</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="analysisOption" id="quickPay" value="quick_pay" checked>
                            <label class="form-check-label" for="quickPay">Quick Analysis ($5)</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="analysisOption" id="expertReview" value="expert_review">
                            <label class="form-check-label" for="expertReview">Expert Review ($50)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Button -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-primary btn-lg px-5" onclick="startAnalysis()">
                <i class="fas fa-magic me-2"></i>
                Start Faculty Matching Analysis
            </button>
            <p class="text-muted mt-2 small">
                Get personalized recommendations based on your CV and research interests
            </p>
        </div>
    </div>

    <!-- Results Section (Hidden initially) -->
    <div id="resultsSection" class="row" style="display: none;">
        <div class="col-12">
            <div class="analysis-result">
                <h5>
                    <i class="fas fa-chart-line me-2"></i>Analysis Results
                </h5>
                <div id="analysisContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Academic field mappings
const academicFields = {
    "health_sciences": [
        "Medicine/Medical Sciences", "Nursing", "Dentistry", "Pharmacy/Pharmacology", 
        "Public Health/Epidemiology", "Veterinary Medicine", "Physical Therapy", 
        "Occupational Therapy", "Speech-Language Pathology", "Clinical Psychology", 
        "Health Administration", "Medical Laboratory Science", "Radiologic Technology", 
        "Nutrition/Dietetics", "Health Informatics", "Biomedical Engineering", 
        "Medical Physics", "Pathology", "Immunology", "Microbiology", 
        "Parasitology", "Virology", "Oncology", "Cardiology", "Neurology", 
        "Psychiatry", "Pediatrics", "Geriatrics", "Emergency Medicine", 
        "Anesthesiology", "Surgery", "Orthopedics", "Ophthalmology", 
        "Dermatology", "Radiology", "Rehabilitation Sciences", "Global Health"
    ],
    "life_sciences": [
        "Biology/General Biology", "Biochemistry", "Molecular Biology", "Cell Biology", 
        "Genetics/Genomics", "Bioinformatics", "Biotechnology", "Ecology", 
        "Evolution", "Marine Biology", "Botany", "Zoology", "Entomology", 
        "Ornithology", "Mammalogy", "Herpetology", "Ichthyology", "Mycology", 
        "Microbiology", "Virology", "Bacteriology", "Physiology", "Anatomy", 
        "Neuroscience", "Behavioral Biology", "Conservation Biology", 
        "Environmental Biology", "Developmental Biology", "Synthetic Biology", 
        "Systems Biology", "Computational Biology", "Structural Biology"
    ],
    "physical_sciences": [
        "Physics", "Chemistry", "Astronomy/Astrophysics", "Earth Sciences/Geology", 
        "Atmospheric Sciences/Meteorology", "Oceanography", "Materials Science", 
        "Nanotechnology", "Theoretical Physics", "Experimental Physics", 
        "Quantum Physics", "Nuclear Physics", "Particle Physics", "Condensed Matter Physics", 
        "Optics/Photonics", "Acoustics", "Organic Chemistry", "Inorganic Chemistry", 
        "Physical Chemistry", "Analytical Chemistry", "Environmental Chemistry", 
        "Geochemistry", "Cosmology", "Planetary Science", "Seismology", 
        "Volcanology", "Mineralogy", "Petrology", "Crystallography"
    ],
    "engineering": [
        "Mechanical Engineering", "Electrical Engineering", "Civil Engineering", 
        "Chemical Engineering", "Aerospace Engineering", "Biomedical Engineering", 
        "Environmental Engineering", "Industrial Engineering", "Materials Engineering", 
        "Nuclear Engineering", "Petroleum Engineering", "Mining Engineering", 
        "Agricultural Engineering", "Food Engineering", "Ocean Engineering", 
        "Automotive Engineering", "Robotics Engineering", "Mechatronics", 
        "Systems Engineering", "Engineering Management", "Safety Engineering", 
        "Quality Engineering", "Manufacturing Engineering", "Process Engineering", 
        "Structural Engineering", "Geotechnical Engineering", "Transportation Engineering", 
        "Water Resources Engineering", "Engineering Physics"
    ],
    "computer_science": [
        "Computer Science/General", "Software Engineering", "Computer Engineering", 
        "Information Technology", "Information Systems", "Cybersecurity", 
        "Data Science", "Machine Learning", "Artificial Intelligence", 
        "Human-Computer Interaction", "Computer Graphics", "Computer Vision", 
        "Natural Language Processing", "Robotics", "Database Systems", 
        "Computer Networks", "Distributed Systems", "Operating Systems", 
        "Programming Languages", "Software Architecture", "Web Development", 
        "Mobile App Development", "Game Development", "DevOps", 
        "Cloud Computing", "Big Data", "Blockchain", "Quantum Computing", 
        "Information Security", "Digital Forensics", "Bioinformatics"
    ],
    "mathematics": [
        "Pure Mathematics", "Applied Mathematics", "Statistics", "Probability", 
        "Mathematical Modeling", "Computational Mathematics", "Operations Research", 
        "Actuarial Science", "Mathematical Physics", "Number Theory", 
        "Algebra", "Geometry", "Topology", "Analysis", "Differential Equations", 
        "Discrete Mathematics", "Combinatorics", "Graph Theory", "Logic", 
        "Set Theory", "Cryptography", "Financial Mathematics", "Biostatistics", 
        "Econometrics", "Mathematical Biology", "Optimization", "Numerical Analysis"
    ],
    "social_sciences": [
        "Psychology", "Sociology", "Anthropology", "Political Science", 
        "International Relations", "Economics", "Geography", "History", 
        "Archaeology", "Criminology", "Social Work", "Public Administration", 
        "Urban Planning", "Development Studies", "Gender Studies", 
        "Cultural Studies", "Media Studies", "Communication", "Linguistics", 
        "Philosophy", "Religious Studies", "Ethics", "Law/Legal Studies", 
        "Human Rights", "Peace Studies", "Conflict Resolution", "Public Policy", 
        "Demography", "Social Psychology", "Cognitive Psychology", "Clinical Psychology"
    ],
    "humanities": [
        "Literature", "History", "Philosophy", "Languages/Linguistics", 
        "Art History", "Music", "Theater/Drama", "Film Studies", 
        "Creative Writing", "Translation Studies", "Classical Studies", 
        "Medieval Studies", "Renaissance Studies", "Modern Languages", 
        "Comparative Literature", "Cultural Studies", "Religious Studies", 
        "Theology", "Ethics", "Aesthetics", "Rhetoric", "Library Science", 
        "Museum Studies", "Digital Humanities", "Heritage Studies"
    ],
    "business": [
        "Business Administration", "Management", "Marketing", "Finance", 
        "Accounting", "Economics", "Entrepreneurship", "International Business", 
        "Operations Management", "Human Resources", "Organizational Behavior", 
        "Strategic Management", "Supply Chain Management", "Project Management", 
        "Business Analytics", "E-commerce", "Digital Marketing", "Brand Management", 
        "Investment Management", "Corporate Finance", "Risk Management", 
        "Real Estate", "Insurance", "Banking", "Consulting", "Business Ethics", 
        "Sustainable Business", "Innovation Management"
    ],
    "education": [
        "Education/General", "Curriculum and Instruction", "Educational Psychology", 
        "Educational Administration", "Special Education", "Early Childhood Education", 
        "Elementary Education", "Secondary Education", "Higher Education", 
        "Adult Education", "Distance Learning", "Educational Technology", 
        "Language Education", "Mathematics Education", "Science Education", 
        "Social Studies Education", "Art Education", "Music Education", 
        "Physical Education", "Health Education", "Vocational Education", 
        "Teacher Training", "Educational Assessment", "Educational Policy", 
        "Comparative Education", "International Education"
    ],
    "environmental": [
        "Environmental Science", "Environmental Studies", "Ecology", 
        "Conservation Biology", "Environmental Chemistry", "Environmental Physics", 
        "Environmental Engineering", "Climate Science", "Sustainability Studies", 
        "Natural Resource Management", "Wildlife Management", "Forestry", 
        "Environmental Policy", "Environmental Law", "Environmental Economics", 
        "Renewable Energy", "Environmental Health", "Pollution Control", 
        "Waste Management", "Water Resources", "Soil Science", "Atmospheric Science", 
        "Environmental Monitoring", "Environmental Impact Assessment", 
        "Green Technology", "Carbon Management"
    ],
    "interdisciplinary": [
        "Cognitive Science", "Neuroscience", "Bioinformatics", "Computational Biology", 
        "Science, Technology & Society", "History of Science", "Philosophy of Science", 
        "Bioethics", "Medical Humanities", "Digital Humanities", "Environmental Humanities", 
        "Science Communication", "Technology Studies", "Innovation Studies", 
        "Future Studies", "Complexity Science", "Network Science", "Data Science", 
        "Sustainability Science", "Global Studies", "Area Studies", "Ethnic Studies", 
        "Women's Studies", "Disability Studies", "Science Policy", "Technology Policy"
    ]
};

let selectedFile = null;

function updateNarrowFields() {
    const broadCategory = document.getElementById('broadCategory').value;
    const narrowField = document.getElementById('narrowField');
    
    narrowField.innerHTML = '<option value="">Select a specific field</option>';
    
    if (broadCategory && academicFields[broadCategory]) {
        academicFields[broadCategory].forEach(field => {
            const option = document.createElement('option');
            option.value = field.toLowerCase().replace(/[^a-z0-9]/g, '_');
            option.textContent = field;
            narrowField.appendChild(option);
        });
    }
}

function selectAI(aiService) {
    // Remove selected class from all cards
    document.querySelectorAll('.ai-service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    event.target.closest('.ai-service-card').classList.add('selected');
    
    // Update hidden input
    document.getElementById('selectedAI').value = aiService;
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        // Validate file type
        const allowedTypes = [
            'application/pdf',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/msword'
        ];
        
        if (!allowedTypes.includes(file.type)) {
            alert('Please select a PDF or Word document.');
            return;
        }
        
        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            return;
        }
        
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileInfo').style.display = 'block';
        
        // Update upload area
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.innerHTML = `
            <div class="file-icon" style="color: #28a745;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h5 style="color: #28a745;">File Selected</h5>
            <p class="text-muted">${file.name}</p>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFile()">Choose Different File</button>
        `;
    }
}

function clearFile() {
    selectedFile = null;
    document.getElementById('cvFile').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    
    // Reset upload area
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.innerHTML = `
        <div class="file-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h5>Drag & Drop your CV here</h5>
        <p class="text-muted mb-3">or click to browse files</p>
        <p class="small text-muted">
            Supported formats: PDF, DOCX (Max size: 10MB)
        </p>
    `;
}

function startAnalysis() {
    // Validate required fields
    const broadCategory = document.getElementById('broadCategory').value;
    const narrowField = document.getElementById('narrowField').value;
    const selectedAI = document.querySelector('input[name="ai_service"]:checked');
    const analysisOption = document.querySelector('input[name="analysis_option"]:checked');
    
    if (!selectedFile) {
        alert('Please upload your CV first.');
        return;
    }
    
    if (!broadCategory || !narrowField) {
        alert('Please select both broad category and specific field.');
        return;
    }
    
    if (!selectedAI) {
        alert('Please select an AI service.');
        return;
    }
    
    if (!analysisOption) {
        alert('Please select an analysis option.');
        return;
    }
    
    {% if not current_user.is_authenticated %}
    // Validate guest user required fields
    const guestName = document.getElementById('guestName').value.trim();
    const guestEmail = document.getElementById('guestEmail').value.trim();
    const guestLevel = document.getElementById('guestLevel').value;
    
    if (!guestName) {
        alert('Please enter your full name.');
        document.getElementById('guestName').focus();
        return;
    }
    
    if (!guestEmail) {
        alert('Please enter your email address.');
        document.getElementById('guestEmail').focus();
        return;
    }
    
    if (!guestLevel) {
        alert('Please select your academic level.');
        document.getElementById('guestLevel').focus();
        return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(guestEmail)) {
        alert('Please enter a valid email address.');
        document.getElementById('guestEmail').focus();
        return;
    }
    {% endif %}
    
    if (analysisOption.value === 'api_key') {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Please enter your API key or choose a different payment option.');
            return;
        }
    }
    
    // Collect all form data
    const formData = new FormData();
    formData.append('cv_file', selectedFile);
    formData.append('ai_service', selectedAI.value);
    formData.append('broad_category', broadCategory);
    formData.append('narrow_field', narrowField);
    formData.append('analysis_option', analysisOption.value);
    
    // Add user profile data
    {% if current_user.is_authenticated %}
        formData.append('user_name', document.getElementById('userName').value);
        formData.append('user_institution', document.getElementById('userInstitution').value);
        formData.append('user_level', document.getElementById('userLevel').value);
        formData.append('user_website', document.getElementById('userWebsite').value);
        formData.append('user_orcid', document.getElementById('userOrcid').value);
        formData.append('user_bio', document.getElementById('userBio').value);
    {% else %}
        // Add guest user data
        formData.append('guest_name', document.getElementById('guestName').value);
        formData.append('guest_email', document.getElementById('guestEmail').value);
        formData.append('guest_phone', document.getElementById('guestPhone').value);
        formData.append('guest_institution', document.getElementById('guestInstitution').value);
        formData.append('guest_level', document.getElementById('guestLevel').value);
        formData.append('guest_website', document.getElementById('guestWebsite').value);
        formData.append('guest_location', document.getElementById('guestLocation').value);
        formData.append('guest_contact_method', document.getElementById('preferredContact').value);
        formData.append('guest_bio', document.getElementById('guestBio').value);
    {% endif %}
    
    formData.append('research_keywords', document.getElementById('researchKeywords').value);
    formData.append('career_goals', document.getElementById('careerGoals').value);
    formData.append('specific_interests', document.getElementById('specificInterests').value);
    
    if (analysisOption.value === 'api_key') {
        formData.append('api_key', document.getElementById('apiKey').value);
    }
    
    // Show loading state
    const button = document.querySelector('button[onclick="startAnalysis()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
    button.disabled = true;
    
    // Submit the form
    fetch('/api/analyze-cv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResults(data.results);
        } else {
            alert('Analysis failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during analysis. Please try again.');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        uploadArea.classList.add('dragover');
    }
    
    function unhighlight(e) {
        uploadArea.classList.remove('dragover');
    }
    
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            const event = { target: { files: files } };
            handleFileSelect(event);
        }
    }
});
</script>
{% endblock %} 